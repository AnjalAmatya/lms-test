<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Piper TTS Test</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; padding: 50px; }
        .container { max-width: 600px; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #status { font-size: 0.9rem; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4">Piper Offline TTS</h2>
    
    <div class="mb-3">
        <label class="form-label">Select Voice</label>
        <select id="voiceSelect" class="form-select">
            <option value="en_US-ryan-high">Ryan (English - High)</option>
            <option value="en_US-hfc_female-medium">HFC Female (English)</option>
            <option value="en_US-lessac-medium">Lessac (English)</option>
        </select>
        <div id="status" class="mt-1">Status: Ready</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Text to Speak</label>
        <textarea id="textInput" class="form-control" rows="3">Hello! I am speaking completely offline using Piper and WebAssembly.</textarea>
    </div>

    <button id="speakBtn" class="btn btn-primary w-100">Generate & Speak</button>
    
    <hr>
    <audio id="audioPlayer" controls class="w-100 d-none"></audio>
</div>

<script type="module">
    import * as tts from 'https://cdn.jsdelivr.net/npm/@mintplex-labs/piper-tts-web@1.0.4/+esm';

    const speakBtn = document.getElementById('speakBtn');
    const voiceSelect = document.getElementById('voiceSelect');
    const textInput = document.getElementById('textInput');
    const status = document.getElementById('status');
    const audioPlayer = document.getElementById('audioPlayer');

    speakBtn.onclick = async () => {
        const voiceId = voiceSelect.value;
        const text = textInput.value;

        try {
            speakBtn.disabled = true;
            status.innerText = "Status: Loading model/Synthesizing...";

            // 1. Synthesize (This will download the model on the first run)
            const wavBlob = await tts.predict({
                text: text,
                voiceId: voiceId,
            }, (progress) => {
                status.innerText = `Status: Downloading model... ${Math.round(progress.loaded / 1024 / 1024)}MB`;
            });

            // 2. Play the resulting audio
            const url = URL.createObjectURL(wavBlob);
            audioPlayer.src = url;
            audioPlayer.classList.remove('d-none');
            audioPlayer.play();
            
            status.innerText = "Status: Done!";
        } catch (err) {
            console.error(err);
            status.innerText = "Status: Error occurred.";
        } finally {
            speakBtn.disabled = false;
        }
    };
</script>

</body>
</html>